<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace를 통해 StatisticsDAO와 연결 -->
<mapper namespace="com.sharp.ing.domain.StatisticsDAO">

<resultMap id="CategoryAvg" type="com.sharp.ing.domain.CategoryAvgDTO">
	</resultMap>

	<select id="categoryAvg3" resultMap="CategoryAvg">
	<![CDATA[
	select l2.code02_vl, sum(i.price)/tot.total*100 as percentage
	from (select sum(i.price) as total
			from shopping_list s, item i, User u
			where s.user_id=#{user_id} and s.user_id=u.user_id and s.list_id=i.list_id and s.purchase_date >= DATE_ADD(now(), interval -3 month)) as tot, shopping_list s, item i, level2 l2, User u
	where s.user_id=#{user_id} and s.user_id=u.user_id and s.list_id=i.list_id and i.code02=l2.code02 and s.purchase_date >= DATE_ADD(now(), interval -3 month) 
	group by l2.code02_vl, tot.total;
	]]>
	</select>
	<select id="categoryAvg6" resultMap="CategoryAvg">
	<![CDATA[
	select l2.code02_vl, sum(i.price)/tot.total*100 as percentage
	from (select sum(i.price) as total
			from shopping_list s, item i, User u
			where s.user_id=#{user_id} and s.user_id=u.user_id and s.list_id=i.list_id and s.purchase_date >= DATE_ADD(now(), interval -6 month)) as tot, shopping_list s, item i, level2 l2, User u
	where s.user_id=#{user_id} and s.user_id=u.user_id and s.list_id=i.list_id and i.code02=l2.code02 and s.purchase_date >= DATE_ADD(now(), interval -6 month) 
	group by l2.code02_vl, tot.total;
	]]>
	</select>
	<select id="categoryAvg12" resultMap="CategoryAvg">
	<![CDATA[
	select l2.code02_vl, sum(i.price)/tot.total*100 as percentage
	from (select sum(i.price) as total
			from shopping_list s, item i, User u
			where s.user_id=#{user_id} and s.user_id=u.user_id and s.list_id=i.list_id and s.purchase_date >= DATE_ADD(now(), interval -12 month))as tot, shopping_list s, item i, level2 l2, User u
	where  s.user_id=#{user_id} and s.user_id=u.user_id and s.list_id=i.list_id and i.code02=l2.code02 and s.purchase_date >= DATE_ADD(now(), interval -12 month) 
	group by l2.code02_vl, tot.total;
	]]>
	</select>
	
</mapper>